# è³‡æ–™åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ­¤åŠŸèƒ½æä¾›å®Œæ•´çš„å·¥ä½œè¨ˆç•«è³‡æ–™åŒ¯å‡ºèˆ‡åŒ¯å…¥èƒ½åŠ›,æ”¯æ´:
- âœ… ä¸€éµåŒ¯å‡ºæ‰€æœ‰è³‡æ–™ç‚º ZIP å£“ç¸®æª”
- âœ… ZIP æª”æ¡ˆæ ¼å¼é©—è­‰ (çµæ§‹ã€æª”åã€æ˜ŸæœŸæ—¥æª¢æŸ¥)
- âœ… å®‰å…¨åŒ¯å…¥ (Zip Slip é˜²è­·ã€åŸå­æ€§æ“ä½œã€è‡ªå‹•å›æ»¾)
- âœ… ä½¿ç”¨è€…å‹å–„çš„éŒ¯èª¤/è­¦å‘Šè¨Šæ¯

## ğŸš€ å¿«é€Ÿé–‹å§‹

### åŒ¯å‡ºè³‡æ–™

1. é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ è¨­å®šã€åœ–ç¤º
2. åœ¨ã€Œè³‡æ–™ç®¡ç†ã€å€å¡Šé»æ“Šã€ŒåŒ¯å‡ºè³‡æ–™ã€
3. ç³»çµ±æœƒè‡ªå‹•ä¸‹è¼‰ `export_data_YYYYMMDD_HHMMSS.zip`

**æª”æ¡ˆçµæ§‹**:
```
export_data_20251025_143022.zip
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ Day/
â”‚   â”‚   â”œâ”€â”€ 20251001.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Week/
â”‚   â”‚   â”œâ”€â”€ 20250929.md  # å¿…é ˆæ˜¯æ˜ŸæœŸæ—¥
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Month/
â”‚   â”‚   â”œâ”€â”€ 202510.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ Year/
â”‚       â”œâ”€â”€ 2024.md
â”‚       â””â”€â”€ 2025.md
```

### åŒ¯å…¥è³‡æ–™

1. é»æ“Šå³ä¸Šè§’ã€Œâš™ï¸ è¨­å®šã€åœ–ç¤º
2. åœ¨ã€Œè³‡æ–™ç®¡ç†ã€å€å¡Šé»æ“Šã€Œé¸æ“‡æª”æ¡ˆåŒ¯å…¥ã€
3. é¸æ“‡è¦åŒ¯å…¥çš„ ZIP æª”æ¡ˆ
4. ç³»çµ±æœƒè‡ªå‹•:
   - âœ… é©—è­‰æª”æ¡ˆæ ¼å¼å’Œçµæ§‹
   - âœ… é¡¯ç¤ºé©—è­‰çµæœ (éŒ¯èª¤/è­¦å‘Š)
   - âœ… è©¢å•ç¢ºèª (è‹¥é©—è­‰é€šé)
   - âœ… åŸ·è¡ŒåŒ¯å…¥ (å‚™ä»½â†’åŒ¯å…¥â†’æ¸…ç† or å›æ»¾)
   - âœ… è‡ªå‹•é‡æ–°æ•´ç†é é¢

## ğŸ“ æŠ€è¡“è¦æ ¼

### API ç«¯é»

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/api/export/create` | POST | å»ºç«‹åŒ¯å‡º ZIP æª”æ¡ˆ |
| `/api/export/download/{filename}` | GET | ä¸‹è¼‰åŒ¯å‡ºçš„ ZIP |
| `/api/import/validate` | POST | é©—è­‰ä¸Šå‚³çš„ ZIP æª”æ¡ˆ |
| `/api/import/execute` | POST | åŸ·è¡Œè³‡æ–™åŒ¯å…¥ |

è©³ç´° API è¦æ ¼è«‹åƒè€ƒ:
- [export-api.yaml](./contracts/export-api.yaml)
- [import-api.yaml](./contracts/import-api.yaml)

### è³‡æ–™æ¨¡å‹

è«‹åƒè€ƒ [data-model.md](./data-model.md)

## ğŸ”’ å®‰å…¨æ€§

### Zip Slip é˜²è­·

ä½¿ç”¨ `Path.resolve()` é©—è­‰è§£å£“è·¯å¾‘:
```python
resolved_path = member_path.resolve()
target_resolved = target_dir.resolve()

if not str(resolved_path).startswith(str(target_resolved)):
    raise SecurityError(f"åµæ¸¬åˆ° Zip Slip æ”»æ“Š: {member}")
```

### æª”åå®‰å…¨

ä¸‹è¼‰ç«¯é»ä½¿ç”¨æ­£å‰‡é©—è­‰æª”å:
```python
if not re.match(r'^export_data_\d{8}_\d{6}\.zip$', filename):
    raise HTTPException(status_code=400)
```

## ğŸ¯ é©—è­‰è¦å‰‡

### 1. æª”æ¡ˆå¤§å°
- ä¸Šé™: 100MB
- è¶…éæœƒå›å‚³ `ErrorType.SIZE` éŒ¯èª¤

### 2. ç›®éŒ„çµæ§‹
- å¿…é ˆåŒ…å«: `Day/`, `Week/`, `Month/`, `Year/`
- ç¼ºå°‘ä»»ä½•ç›®éŒ„æœƒå›å‚³ `ErrorType.STRUCTURE` éŒ¯èª¤

### 3. æª”åæ ¼å¼

| ç›®éŒ„ | æ ¼å¼ | ç¯„ä¾‹ |
|------|------|------|
| Day | `YYYYMMDD.md` | `20251025.md` |
| Week | `YYYYMMDD.md` (å¿…é ˆæ˜¯æ˜ŸæœŸæ—¥) | `20251019.md` |
| Month | `YYYYMM.md` | `202510.md` |
| Year | `YYYY.md` | `2025.md` |

### 4. æ˜ŸæœŸæ—¥æª¢æŸ¥
- Week ç›®éŒ„çš„æª”æ¡ˆå¿…é ˆä»¥æ˜ŸæœŸæ—¥æ—¥æœŸå‘½å
- ä½¿ç”¨ `datetime.weekday() == 6` é©—è­‰
- éŒ¯èª¤ç¯„ä¾‹: `20251020.md` (æ˜ŸæœŸä¸€) â†’ `ErrorType.WEEKDAY`

## ğŸ”„ åŸå­æ€§æ“ä½œ

åŒ¯å…¥æµç¨‹ç¢ºä¿åŸå­æ€§:
1. **é©—è­‰**: å…ˆé©—è­‰æª”æ¡ˆæ ¼å¼,å¤±æ•—å‰‡ä¸­æ–·
2. **å‚™ä»½**: å‚™ä»½ç•¶å‰ `backend/data` è‡³ `/tmp/backup_data_*`
3. **æ¸…ç©º**: åˆªé™¤ç¾æœ‰ `backend/data`
4. **åŒ¯å…¥**: è§£å£“ ZIP æª”æ¡ˆåˆ° `backend/data`
5. **æˆåŠŸ**: åˆªé™¤å‚™ä»½å’Œè‡¨æ™‚æª”æ¡ˆ
6. **å¤±æ•—**: å¾å‚™ä»½é‚„åŸä¸¦æ¸…ç†

```python
try:
    backup_path = backup_current_data()
    # ... åŸ·è¡ŒåŒ¯å…¥
    shutil.rmtree(backup_path)  # æˆåŠŸå¾Œæ¸…ç†
except Exception:
    restore_backup(backup_path)  # å¤±æ•—å‰‡å›æ»¾
    raise
```

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

| æ“ä½œ | ç›®æ¨™ | å¯¦æ¸¬ |
|------|------|------|
| åŒ¯å‡º (1000 æª”æ¡ˆ) | < 3s | âœ… |
| é©—è­‰ (1000 æª”æ¡ˆ) | < 5s | âœ… |
| åŒ¯å…¥ (1000 æª”æ¡ˆ) | < 10s | âœ… |
| ä¸‹è¼‰å›æ‡‰æ™‚é–“ | < 100ms | âœ… |

## ğŸ§ª æ¸¬è©¦

### å¾Œç«¯æ¸¬è©¦
```bash
cd /home/dev/projects/work-plan-by-calendar
source .venv/bin/activate
pytest tests/test_data_export_service.py -v
```

### æ‰‹å‹•æ¸¬è©¦æª¢æŸ¥æ¸…å–®
è«‹åƒè€ƒ [manual-test-results.md](./checklists/manual-test-results.md)

## ğŸ“ è®Šæ›´è¨˜éŒ„

### v1.0.0 (2025-10-25)
- âœ… Phase 1: ç’°å¢ƒé©—è­‰
- âœ… Phase 2: æ ¸å¿ƒæ¨¡å‹å»ºç«‹
- âœ… Phase 3: åŒ¯å‡ºåŠŸèƒ½å¯¦ä½œ
- âœ… Phase 4: é©—è­‰åŠŸèƒ½å¯¦ä½œ
- âœ… Phase 5: åŒ¯å…¥åŸ·è¡Œå¯¦ä½œ
- âœ… Phase 6: è³‡æ–™é¡¯ç¤ºé©—è­‰
- âœ… Phase 7: æœ€çµ‚å„ªåŒ–å’Œæ–‡ä»¶

è©³ç´°ä»»å‹™æ¸…å–®è«‹åƒè€ƒ [tasks.md](./tasks.md)

## ğŸ› å·²çŸ¥å•é¡Œ

ç„¡

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [åŠŸèƒ½è¦æ ¼](./spec.md)
- [å¯¦ä½œè¨ˆç•«](./plan.md)
- [è³‡æ–™æ¨¡å‹](./data-model.md)
- [API è¦æ ¼](./contracts/)
- [å¿«é€Ÿé–‹å§‹](./quickstart.md)
- [ä»»å‹™æ¸…å–®](./tasks.md)

## ğŸ‘¥ è²¢ç»è€…

- é–‹ç™¼: GitHub Copilot + Claude Sonnet 4.5
- æ¸¬è©¦: æ‰‹å‹•æ¸¬è©¦ + pytest

## ğŸ“„ æˆæ¬Š

éµå¾ªå°ˆæ¡ˆä¸»è¦æˆæ¬Š
